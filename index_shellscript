#!/bin/bash

# Start logging
exec > >(tee /var/log/user-data.log) 2>&1
echo "User data script started"

# Update system packages
yum update -y
echo "System packages updated"

# Install Java (required for Jenkins)
yum install -y java-11-openjdk
echo "Java installed"

# Add Jenkins repository and import the key
wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
echo "Jenkins repository added"

# Install Jenkins
yum install -y jenkins
echo "Jenkins installed"

# Start and enable Jenkins service
systemctl enable jenkins
systemctl start jenkins
echo "Jenkins started"

# Install Git
yum install -y git
echo "Git installed"

# Install AWS CLI
yum install -y aws-cli
echo "AWS CLI installed"

# Install Node.js and PM2
curl -fsSL https://rpm.nodesource.com/setup_16.x | bash -
yum install -y nodejs
npm install -g pm2
echo "Node.js and PM2 installed"

# Clone GitHub Repository
APP_DIR="/var/www/app"
GITHUB_REPO="https://github.com/kishorelevis/AWS_Project.git"

mkdir -p $APP_DIR
cd $APP_DIR

if [ ! -d ".git" ]; then
    git clone $GITHUB_REPO .
    echo "Repository cloned"
else
    git pull origin main
    echo "Repository updated"
fi

# Install required Node.js packages
npm install express multer aws-sdk
echo "Node.js packages installed"

# Create the Node.js server (server.js)
cat <<EOF > $APP_DIR/server.js
const express = require('express');
const multer = require('multer');
const AWS = require('aws-sdk');
const path = require('path');
const app = express();

// AWS Configuration
AWS.config.update({ region: 'us-east-1' });
const s3 = new AWS.S3();

// Multer Storage (Temporary Memory)
const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

// Upload API
app.post('/upload', upload.single('file'), (req, res) => {
    const params = {
        Bucket: 's3-pro3-rawbucket',  // Replace with your S3 bucket
        Key: \`\${Date.now()}-\${path.basename(req.file.originalname)}\`,
        Body: req.file.buffer,
        ContentType: req.file.mimetype,
    };

    s3.upload(params, (err, data) => {
        if (err) {
            console.error("Error uploading:", err);
            return res.status(500).send('Error uploading file to S3');
        }
        console.log("File uploaded:", data.Location);
        res.send(\`File uploaded successfully! <a href="/">Back to home</a>\`);
    });
});

// Serve the HTML upload form
app.get('/', (req, res) => {
    res.sendFile('/var/www/app/index.html');
});

// Start server
app.listen(80, '0.0.0.0', () => {
    console.log('Server running on http://<your-ec2-ip>');
});
EOF
echo "server.js created"

# Start the Node.js application with PM2
cd $APP_DIR
pm2 start server.js --name "file-upload-app"
pm2 save
pm2 startup systemd
echo "Node.js app started with PM2"

# Display the initial Jenkins admin password
echo "Jenkins setup completed. Get the initial admin password using:"
echo "sudo cat /var/lib/jenkins/secrets/initialAdminPassword"

echo "User data script completed"
